<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<link rel="import" href="../login-app/login-app.html">
<link rel="import" href="asp-elements.html">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

<dom-module id="asp-app">
  <template>
    <style is="custom-style" >

  	  paper-scroll-header-panel {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: var(--paper-grey-200, #eee);;
      }
      #msg_error {
        --paper-toast-background-color: red;
        --paper-toast-color: white;
      }
    </style>


    <akc-meta key="logged" value="[[_computeLoggedState(_statusKnown,_user)]]"></akc-meta>
    <akc-meta key="user" value="[[_user]]"></akc-meta>
    <firebase-auth
           id="auth"
           app-name="asp_project01"
           status-known="{{_statusKnown}}"
           user="{{_user}}">
    </firebase-auth>


    <app-location route="{{route}}" ></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{data}}"
        tail="{{tail}}">
    </app-route>

    <iron-pages attr-for-selected="id" selected="{{data.page}}">
      <login-app
        id="login"
        on-sign-in="signIn" ></login-app>

      <paper-scroll-header-panel
        id="home"
        fixed >
              <asp-header
                on-lock-in="lock">
              </asp-header>
              <asp-content>
              </asp-content>

      </paper-scroll-header-panel>



   </iron-pages>



<paper-toast
  id="msg_error"
  duration="5000"
  class="fit-bottom"
  text="[[msg]]"></paper-toast>

  </template>
  <script>
    Polymer({
      is: 'asp-app',
      properties : {
        _statusKnown: {
          type: Boolean,
          value: false
        },

        /**
         * User used for the `<firebase-auth>` inner element
         */
        _user: {
          type: Object
        },
        msg:String,
        data: {
            type: Object,
            value: function() {
              return {
                page: '/login/'
              };
            }
        },
        signedIn: {
          type: Boolean,
          notify:true
        },
        route: {
            type: Object,
            value: function() {
              return {

              };
            }
            /*,
            observer:'_onRouteChanged'*/
          }

      },
      ready: function() {
          this.set('route.path', '/login/');
      },

      _computeLoggedState: function(statusKnown, user) {
        return statusKnown && !!user;
      },


      signIn(e) {
        this.$.auth.signInWithPopup(e.detail.provider)
        .then((response)=>{
             console.log('Login correcto, pasando a HOME');
             this.set('route.path', '/home/');
        })
        .catch((error)=> {
          this.handleError(error);
        });

      },
      lock() {
        console.log("cerrando sesion");
        if (this.$.auth) {
            this.$.auth.signOut();
            this.set('route.path', '/login/');
        }
      },
      handleError:function(error){
        //console.log(JSON.stringify(error));
         console.log('Ocurrio un error en el login. '+error.code);
         this.msg="" ;
        if(error.code=='auth/account-exists-with-different-credential')
          { this.msg="Ya existe una cuenta registrada con estes correo"}
        else if(error.code=='auth/network-request-failed')
          { this.msg="No hay conexión a internet";}
        else{
          this.msg="Error general, intente más tarde";
        }
        this.$.msg_error.open();
        //console.log(JSON.stringify(error) );
      }

    });
  </script>
</dom-module>
